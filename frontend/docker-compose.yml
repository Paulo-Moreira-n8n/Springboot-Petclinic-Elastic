# version: "3.9"

name: docker-elk-petclinic-frontend

services:
  # ----------------------------------------------------------
  # Frontend Server (Node/Express) - serve o build do client
  # ----------------------------------------------------------
  petclinic-frontend:
    build:
      context: .
      dockerfile: Dockerfile
    image: spring-petclinic-client:latest
    container_name: spring-petclinic-client
    restart: unless-stopped
#    depends_on:
#      - apm-server
#      - elasticsearch
#      apm-server:
#        condition: service_healthy
#      elasticsearch:
#        condition: service_healthy
    environment:
      # ---- APM / Elasticsearch (para entrypoint carregar sourcemaps) ----
      ELASTIC_APM_SERVER_URL: "http://apm-server:8200"
      ELASTICSEARCH_URL: "http://elasticsearch:9200"
      ELASTICSEARCH_USERNAME: "${ELASTICSEARCH_USERNAME:-elastic}"
      ELASTICSEARCH_PASSWORD: "${ELASTICSEARCH_PASSWORD:-changeme}"
      INSECURE_SSL: "${INSECURE_SSL:-false}"

      # ---- Identidade do serviço para o APM (client RUM) ----
      ELASTIC_APM_SERVICE_NAME: "${ELASTIC_APM_SERVICE_NAME:-spring-petclinic-client}"
      ELASTIC_APM_SERVICE_VERSION: "${ELASTIC_APM_SERVICE_VERSION:-1.0.0}"

      # ---- URLs públicas usadas pelo APM para mapear bundle_filepath dos sourcemaps ----
      # INTERNAL: URL vista "de dentro" do cluster (Ingress/Load Balancer interno)
      PETCLINIC_INTERNAL_URL: "${PETCLINIC_INTERNAL_URL:-http://petclinic-frontend:4000}"
      # EXTERNAL: URL pública que os usuários e o RUM usarão
      PETCLINIC_EXTERNAL_URL: "${PETCLINIC_EXTERNAL_URL:-http://localhost:4000}"

      # ---- Porta do server Node (bin/www usa SERVER_PORT=4000 por padrão) ----
      SERVER_PORT: "4000"
#      BIND_IP: "0.0.0.0"

    ports:
      - "4000:4000"  # http://localhost:4000

    networks:
      - elk

#    healthcheck:
#      test: ["CMD-SHELL", "curl -fsS http://localhost:4000/healthcheck || exit 1"]
#      test: ["CMD-SHELL", "curl -fsS http://petclinic-frontend:4000/healthcheck || exit 1"]
#      interval: 10s
#      timeout: 3s
#      retries: 10


# ----------------------------------------------------------
# Redes e Volumes
# ----------------------------------------------------------
networks:
  elk:
    name: docker-elk_elk
    external: true
